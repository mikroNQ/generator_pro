<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Generator ET">
    <meta name="theme-color" content="#f5f5f5">
    
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä 1D, 2D</title>
    
    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root { 
            --primary: #3b82f6; 
            --primary-dark: #2563eb; 
            --success: #10b981; 
            --warning: #f59e0b; 
            --danger: #ef4444; 
            --gray: #6b7280; 
            --light: #f3f4f6; 
            --border: #d1d5db;
            --purple: #8b5cf6; 
            --dark: #1f2937; 
            --radius: 12px;
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-top: env(safe-area-inset-top);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        html { height: 100%; overscroll-behavior-y: none; }

        body { 
            margin: 0; padding: 0; width: 100%; min-height: 100dvh; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e0d5 100%); 
            font-size: 14px;
            -webkit-overflow-scrolling: touch;
            padding-top: max(15px, var(--safe-top));
            padding-bottom: max(40px, var(--safe-bottom));
            padding-left: 15px; padding-right: 15px;
        }
        
        .container { max-width: 550px; margin: 0 auto; }
        
        .card { 
            background: white; border-radius: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            padding: 20px; margin-bottom: 15px; 
        }
        
        /* --- HEADER WITH LOGO --- */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; 
            margin-bottom: 20px;
        }
        
        .app-logo {
            width: 32px; 
            height: 32px;
            object-fit: contain;
        }

        h1 { 
            color: #333; 
            font-size: 1.4em; 
            margin: 0; 
            font-weight: 800; 
            letter-spacing: -0.5px; 
            line-height: 1;
        }
        
        /* --- TABS --- */
        .tabs { display: flex; flex-wrap: wrap; background: var(--light); border-radius: 14px; padding: 4px; margin-bottom: 20px; gap: 4px; }
        .tab-btn { flex: 1 1 auto; padding: 12px 10px; border: none; background: transparent; cursor: pointer; font-size: 0.9em; font-weight: 500; color: var(--gray); border-radius: 10px; transition: all 0.2s; white-space: nowrap; text-align: center; touch-action: manipulation; }
        .tab-btn.active { background: white; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.08); font-weight: 600; }
        .tab-content { display: none; animation: fadeIn 0.25s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* --- FORMS & INPUTS --- */
        .add-form, .barcode-form, .weight-carousel-form, .simple-gen-form { background: var(--light); border-radius: 16px; padding: 18px; margin-bottom: 15px; border: 1px solid white; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.9em; font-weight: 600; color: #4b5563; margin-bottom: 8px; margin-left: 2px; }

        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 16px; background: white; transition: border-color 0.2s, box-shadow 0.2s; appearance: none; -webkit-appearance: none; line-height: 1.4; color: #1f2937; }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.8rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        textarea { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; resize: vertical; min-height: 100px; }
        .input-group { display: flex; gap: 8px; align-items: stretch; }
        .input-group > * { height: 48px; }
        .input-group input, .input-group select { height: 100%; }

        /* --- BUTTONS --- */
        .btn { border: none; border-radius: 20px; padding: 12px 24px; font-size: 0.95em; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.1s, opacity 0.2s; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-primary { background: linear-gradient(145deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-success { background: linear-gradient(145deg, var(--success), #059669); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-warning { background: linear-gradient(145deg, var(--warning), #d97706); color: white; }
        .btn-secondary { background: var(--gray); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-purple { background: linear-gradient(145deg, var(--purple), #7c3aed); color: white; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3); }
        .btn-dark { background: var(--dark); color: white; }
        .btn-outline { background: white; border: 2px solid #e5e7eb; color: var(--gray); }
        .btn-sm { padding: 8px 14px; font-size: 0.85em; border-radius: 14px; }
        .form-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .controls { text-align: center; margin-top: 20px; }

        /* --- SPECIFIC MODULES --- */
        #code-container { background: var(--light); border-radius: 12px; padding: 15px; text-align: center; border: 1px dashed var(--border); flex: 1; max-width: 250px; }
        #datamatrix-container { width: 100%; height: auto; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #datamatrix-container canvas { width: 90% !important; height: 90% !important; object-fit: contain; }
        
        .mode-badge { display: inline-block; padding: 6px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; margin-bottom: 12px; }
        .mode-badge.default { display: none; }
        .mode-badge.list { background: #fef3c7; color: #92400e; }
        .code-info { background: #e0f2fe; border-radius: 10px; padding: 12px; margin: 12px 0; font-size: 0.85em; }
        .code-info .label { color: #0369a1; font-weight: 500; }
        .code-info .value { font-family: monospace; color: #0c4a6e; font-weight: 700; font-size: 1.1em; }
        #current-code { font-family: monospace; font-size: 13px; background: #333; color: #fff; padding: 10px; border-radius: 8px; word-break: break-all; text-align: center; margin: 12px 0; max-height: 60px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        .interval-selector { display: flex; align-items: center; justify-content: center; gap: 8px; margin: 15px auto; flex-wrap: wrap; background: #fff; padding: 8px; border-radius: 14px; border: 1px solid var(--border); max-width: 100%; }
        .interval-btn, .wc-interval-btn { padding: 8px 14px; border: 1px solid transparent; background: transparent; border-radius: 10px; font-size: 0.9em; cursor: pointer; color: var(--gray); font-weight: 500; min-width: 44px; }
        .interval-btn.active, .wc-interval-btn.active { background: #dcfce7; color: #166534; font-weight: 700; }
        .custom-interval-input { width: 60px; padding: 4px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9em; text-align: center; height: 36px; }

        .hint { font-size: 0.8em; color: #6b7280; margin-bottom: 10px; margin-top: 4px; }
        .error-text { color: var(--danger); font-size: 0.8em; margin-top: 4px; }
        .template-selector { margin: 15px 0; }
        .template-btns { display: flex; gap: 10px; }
        .tmpl-btn { flex: 1; padding: 12px; border: 2px solid var(--border); background: white; border-radius: 12px; cursor: pointer; font-size: 0.8em; text-align: center; transition: all 0.2s; }
        .tmpl-btn.active { border-color: var(--success); background: #f0fdf4; color: #166534; }
        .tmpl-btn .tmpl-name { font-weight: 700; display: block; margin-bottom: 4px; font-size: 1.1em; }
        .bulk-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; padding: 12px; background: #fffbeb; border-radius: 12px; border: 1px solid #fcd34d; }
        .rotation-controls { background: var(--light); border-radius: 12px; padding: 15px; margin: 15px 0; text-align: center; }
        .rotation-controls.active { background: #dcfce7; border: 1px solid #86efac; }
        .saved-list h3 { font-size: 1em; color: #333; margin: 20px 0 10px 0; display: flex; align-items: center; justify-content: space-between; }
        #saved-list { max-height: 35vh; overflow-y: auto; padding: 5px; border: 1px solid var(--border); border-radius: 12px; background: #fff; -webkit-overflow-scrolling: touch; }
        
        .saved-item, .weight-item { background: #f9fafb; border-radius: 10px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; border: 1px solid transparent; transition: all 0.1s; }
        .saved-item.active, .weight-item.active { background: #f0fdf4; border-color: #4ade80; }
        .saved-item .info, .weight-item .info { flex: 1; min-width: 0; }
        .saved-item .barcode, .weight-item .code { font-weight: 700; font-size: 1em; color: #1f2937; font-family: monospace; letter-spacing: 0.5px; }
        .saved-item .actions, .weight-item .actions { display: flex; gap: 12px; }

        .barcode-result { background: var(--light); border-radius: 16px; padding: 25px; margin-top: 15px; text-align: center; }
        .barcode-result .result-text { font-family: monospace; font-size: 1.2em; background: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; word-break: break-all; border: 1px dashed #d1d5db; }
        
        /* FIX OVERFLOWING BARCODE */
        .barcode-result svg, 
        .barcode-carousel-display svg, 
        #sgCarouselSvg,
        #sgSvg { 
            max-width: 100%; 
            height: auto; 
            display: block; 
            margin: 0 auto; 
            background: white; 
            padding: 10px; 
            border-radius: 8px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
        }

        .checkbox-row { display: flex; align-items: center; gap: 10px; font-size: 0.95em; margin: 15px 0; cursor: pointer; padding: 5px 0; }
        .checkbox-row input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--primary); }
        
        .simple-preview { min-height: 140px; display: flex; align-items: center; justify-content: center; background: white; border: 2px dashed #d1d5db; border-radius: 12px; margin-top: 15px; padding: 15px; position: relative; }
        .sg-save-panel { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 18px; margin-top: 15px; }
        .sg-folders-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .folders-section { background: #fff7ed; border: 1px solid #fed7aa; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .sg-folder-row { display: flex; align-items: center; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: transform 0.1s; }
        .sg-folder-row:active { transform: scale(0.98); background: #fafafa; }
        
        .sg-carousel { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 2px solid var(--primary); border-radius: 16px; padding: 15px; margin-top: 15px; gap: 5px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.15); }
        .sg-arrow-btn { background: var(--light); border: 1px solid var(--border); border-radius: 50%; width: 48px; height: 48px; font-size: 1.4em; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--primary); flex-shrink: 0; user-select: none; transition: background 0.2s; -webkit-tap-highlight-color: rgba(0,0,0,0); }
        .sg-arrow-btn:active { background: #dbeafe; }
        .sg-display-area { flex: 1; text-align: center; min-height: 160px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        .sg-item-name { font-weight: 700; color: #333; margin-bottom: 8px; font-size: 1.2em; }
        .sg-item-counter { font-size: 0.85em; color: #888; margin-top: 8px; font-weight: 500; }
        .sg-back-btn { margin-bottom: 15px; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; color: var(--primary); font-size: 1em; font-weight: 600; padding: 10px; }

        .weight-divider { margin: 25px 0; border: 0; border-top: 1px solid #e5e7eb; }
        .weight-mode-switch { display: flex; gap: 10px; background: transparent; margin-bottom: 15px; }
        .weight-mode-label { flex: 1; text-align: center; padding: 14px; font-size: 0.9em; font-weight: 600; cursor: pointer; border-radius: 12px; color: #555; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; background: #e5e7eb; border: 2px solid transparent; }
        .weight-mode-switch input[type="radio"] { display: none; }
        .weight-mode-switch input[type="radio"]:checked + .weight-mode-label { background: white; color: var(--purple); border-color: var(--purple); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2); transform: translateY(-1px); }
        .weight-range-row { display: flex; gap: 10px; align-items: center; }
        .weight-range-row input { flex: 1; }
        .prefix-checkboxes { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .prefix-checkbox { flex: 1; display: flex; align-items: center; gap: 8px; padding: 12px; border: 1px solid var(--border); background: white; border-radius: 12px; cursor: pointer; transition: all 0.2s; min-width: 100px; }
        .prefix-checkbox:has(input:checked) { border-color: var(--purple); background: #f3e8ff; }
        .discount-section { background: #fdf4ff; border: 1px dashed var(--purple); padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        
        .folder-list { max-height: 200px; overflow-y: auto; margin-bottom: 12px; padding-right: 2px; -webkit-overflow-scrolling: touch; }
        .folder-item { background: white; border-radius: 10px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; }
        .folder-item.selected { border-color: var(--purple); background: #f3e8ff; }
        .weight-items-list { max-height: 250px; overflow-y: auto; margin: 10px 0; border: 1px solid var(--border); border-radius: 10px; background: #fff; padding: 5px; -webkit-overflow-scrolling: touch; }
        
        .current-folder-badge { display: inline-block; background: var(--purple); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.8em; margin-left: 8px; font-weight: 600; }
        .barcode-carousel-display { background: white; border-radius: 20px; padding: 25px; margin: 20px 0; text-align: center; border: 2px solid var(--purple); transition: opacity 0.1s; box-shadow: 0 10px 30px rgba(139, 92, 246, 0.15); overflow: hidden; }

        .backup-section { background: #f3f4f6; border: 1px dashed #9ca3af; border-radius: 12px; padding: 15px; margin-top: 25px; text-align: center; }
        .backup-title { font-size: 0.9em; font-weight: 700; color: #4b5563; margin-bottom: 10px; }
        .backup-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        
        /* --- NEW DM VISUAL LAYOUT --- */
        .dm-visual-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
            position: relative;
        }

        .dm-nav-arrow {
            background: transparent;
            border: 2px solid transparent;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.5em;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            user-select: none;
        }
        .dm-nav-arrow:active {
            background: #e0f2fe;
            transform: scale(0.95);
        }

        .dm-carousel-controls { margin-top: 15px; text-align: center; }
        .dm-play-controls { display: flex; gap: 8px; justify-content: center; margin-top: 10px; }

        .d-none { display: none !important; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse { animation: pulse 1.5s infinite; }
        @keyframes scan-flash { 0% { opacity: 0; transform: scale(0.98); } 100% { opacity: 1; transform: scale(1); } }
        .scan-effect { animation: scan-flash 0.15s ease-out forwards; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="app-header">
                <img src="logo.png" alt="Logo" class="app-logo" onerror="this.style.display='none'">
                <h1>Generator ET</h1>
            </div>
            
            <div class="tabs">
                <button class="tab-btn active" data-tab="datamatrix">üì± DM</button>
                <button class="tab-btn" data-tab="library">üìö –ë–∏–±–ª.</button>
                <button class="tab-btn" data-tab="barcode">üè∑Ô∏è –í–µ—Å</button>
                <button class="tab-btn" data-tab="simplegen">üõ†Ô∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
                <button class="tab-btn" data-tab="weightcarousel">‚öñÔ∏è –ö–∞—Ä—É—Å–µ–ª—å</button>
            </div>
            
            <div id="tab-datamatrix" class="tab-content active">
                <div id="mode-indicator"><span class="mode-badge default" id="mode-badge">üì¶ –î–µ–º–æ-—Ä–µ–∂–∏–º</span></div>
                
                <div class="dm-visual-row">
                    <button id="dm-prev-btn" class="dm-nav-arrow" style="display:none">‚ùÆ</button>
                    <div id="code-container"><div id="datamatrix-container"></div></div>
                    <button id="dm-next-btn" class="dm-nav-arrow" style="display:none">‚ùØ</button>
                </div>

                <div class="code-info" id="code-info" style="display:none;">
                    <div><span class="label">GTIN:</span> <span class="value" id="info-barcode">-</span></div>
                    <div><span class="label">–®–∞–±–ª–æ–Ω:</span> <span class="value" id="info-template">-</span></div>
                    <div class="counter" id="info-counter">1 / 1</div>
                </div>
                <div id="current-code">-</div>
                
                <div class="dm-carousel-controls">
                    <div class="interval-selector" style="margin: 0 auto 10px auto;">
                        <button class="interval-btn" data-interval="0.5">0.5</button>
                        <button class="interval-btn active" data-interval="0.7">0.7</button>
                        <button class="interval-btn" data-interval="1">1</button>
                        <button class="interval-btn" data-interval="2">2</button>
                        <input type="number" id="dm-custom-interval" class="custom-interval-input" placeholder="..." step="0.1" min="0.1" value="0.7">
                    </div>
                    <div id="timer" style="text-align: center; margin: 10px 0;">
                        ‚è±Ô∏è <span class="pulse" id="countdown">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</span>
                    </div>
                    <div class="dm-play-controls">
                        <button class="btn btn-warning btn-sm" id="dm-pause-btn">‚è∏ –°—Ç–æ–ø</button>
                        <button class="btn btn-success btn-sm" id="dm-play-btn" style="display:none">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
                        <button class="btn btn-primary btn-sm" id="refresh-btn">‚ú® –û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                </div>
            </div>
            
            <div id="tab-library" class="tab-content">
                <div class="add-form">
                    <label>–î–æ–±–∞–≤–∏—Ç—å GTIN (–±–∞—Ä–∫–æ–¥—ã):</label>
                    <textarea id="barcode-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –±–∞—Ä–∫–æ–¥—ã (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):
4810223039703
4810223036870"></textarea>
                    <div class="hint">üí° –í–≤–µ–¥–∏ EAN-13, –æ—Å—Ç–∞–ª—å–Ω–æ–µ –¥–æ–±–∞–≤–∏—Ç—Å—è –ø–æ —à–∞–±–ª–æ–Ω—É</div>
                    <div class="template-selector">
                        <label>–®–∞–±–ª–æ–Ω DataMatrix:</label>
                        <div class="template-btns">
                            <div class="tmpl-btn active" data-template="type1">
                                <span class="tmpl-name">üì¶ –¢–∏–ø 1</span>
                                <span class="tmpl-desc" style="display:block; font-size:0.85em; color:#666;">–ö–æ—Ä–æ—Ç–∫–∏–π (–¢–∞–±–∞–∫/–í–æ–¥–∞)</span>
                            </div>
                            <div class="tmpl-btn" data-template="type2">
                                <span class="tmpl-name">üîê –¢–∏–ø 2</span>
                                <span class="tmpl-desc" style="display:block; font-size:0.85em; color:#666;">–ü–æ–ª–Ω—ã–π (–û–±—É–≤—å/–û–¥–µ–∂–¥–∞)</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <button class="btn btn-success btn-sm" id="add-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                        <button class="btn btn-secondary btn-sm" id="clear-input-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>
                <div class="bulk-actions">
                    <span style="flex:1; font-size:0.85em; color:#92400e;">–í—ã–±—Ä–∞–Ω–æ: <strong id="selected-count">0</strong></span>
                    <button class="btn btn-outline btn-sm" id="select-all-btn">‚úì –í—Å–µ</button>
                    <button class="btn btn-outline btn-sm" id="deselect-all-btn">‚úï –°–Ω—è—Ç—å</button>
                </div>
                <div class="rotation-controls" id="rotation-controls">
                    <div class="rotation-status" id="rotation-status">–í—ã–±–µ—Ä–∏—Ç–µ GTIN –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏</div>
                    <div style="margin-top:10px; display:flex; justify-content:center; gap:10px;">
                        <button class="btn btn-success btn-sm" id="start-btn">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                        <button class="btn btn-warning btn-sm" id="stop-btn" style="display:none;">‚èπÔ∏è –°—Ç–æ–ø</button>
                    </div>
                </div>
                <div class="saved-list">
                    <h3><span>üíæ –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ GTIN</span><button class="btn btn-danger btn-sm" id="clear-all-btn">–û—á–∏—Å—Ç–∏—Ç—å</button></h3>
                    <div id="saved-list"></div>
                </div>

                <div class="backup-section">
                    <div class="backup-title">üõ†Ô∏è –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                    <div class="backup-actions">
                        <button class="btn btn-primary btn-sm" id="exportDataBtn">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å</button>
                        <button class="btn btn-dark btn-sm" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                        <input type="file" id="importFile" accept=".json" style="display:none">
                    </div>
                    <div class="hint" style="margin-top:8px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ JSON —Ñ–∞–π–ª, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ</div>
                </div>
            </div>
            
            <div id="tab-barcode" class="tab-content">
                <div class="barcode-form">
                    <div class="form-group">
                        <label for="barcodeType">–¢–∏–ø —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ (–í–µ—Å/–¶–µ–Ω–∞)</label>
                        <select id="barcodeType">
                            <option value="code128_19_piece">47-Code128: —à—Ç—É—á–Ω—ã–π (19)</option>
                            <option value="code128_19_weight">49-Code128: –≤–µ—Å–æ–≤–æ–π –£–ö (19)</option>
                            <option value="code128_19_price">44-Code128: —Å —Ü–µ–Ω–æ–π (19)</option>
                            <option value="code128_16_cas">77-Code128: –≤–µ—Å—ã CAS (16)</option>
                            <option value="ean13_weight">22-EAN‚Äë13: –≤–µ—Å–æ–≤–æ–π (13)</option>
                        </select>
                    </div>
                    <div id="barcodeParams"></div>
                    <label class="checkbox-row">
                        <input type="checkbox" id="simulateError">
                        <span>–°–∏–º—É–ª—è—Ü–∏—è –æ—à–∏–±–∫–∏ (CRC)</span>
                    </label>
                    <div class="controls"><button class="btn btn-primary" id="generateBarcodeBtn">üè∑Ô∏è –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button></div>
                </div>
                <div class="barcode-result" id="barcodeResult" style="display:none;">
                    <div class="result-text" id="barcodeText">-</div>
                    <svg id="barcodeSvg"></svg>
                </div>
            </div>

            <div id="tab-simplegen" class="tab-content">
                <div id="sg-view-list">
                    <div class="simple-gen-form">
                        <div class="form-group">
                            <label>1. –°–æ–∑–¥–∞–Ω–∏–µ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</label>
                            <select id="sgType" onchange="handleSimpleGenerator()">
                                <option value="CODE128">Code 128 (–ê–≤—Ç–æ)</option>
                                <option value="EAN13">EAN-13</option>
                                <option value="UPC">UPC</option>
                                <option value="ITF14">ITF-14</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="text" id="sgValue" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ (—Ü–∏—Ñ—Ä—ã)" autocomplete="off">
                        </div>
                        <div class="simple-preview" id="sgPreviewContainer">
                            <span style="color:#999; font-size:0.8em; position:absolute; top:5px; left:10px;">–ü—Ä–µ–≤—å—é</span>
                            <svg id="sgSvg" style="display:none;"></svg>
                        </div>
                        
                        <div class="sg-save-panel">
                            <label style="margin-bottom:10px; font-weight:700; color:#1e40af;">2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–∞–ø–∫—É</label>
                            
                            <div class="form-group">
                                <label style="font-weight:normal; color:#555; font-size:0.8em">–ü–∞–ø–∫–∞:</label>
                                <div class="input-group">
                                    <select id="sgFolderSelect" style="flex:1;"></select>
                                    <input type="text" id="sgFolderInput" class="d-none" style="flex:1" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏">
                                    <button class="btn btn-purple btn-sm" id="sgFolderModeBtn" style="min-width:50px; font-size:1.4em; padding:0; border-radius:10px;" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–∞–ø–∫—É">Ôºã</button>
                                </div>
                            </div>

                            <div class="form-group">
                                 <label style="font-weight:normal; color:#555; font-size:0.8em">–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞—Ä–∫–æ–¥–∞:</label>
                                <input type="text" id="sgName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞—Ä—Ç–∞ –°–∫–∏–¥–∫–∞">
                            </div>
                            
                            <button class="btn btn-success" style="width:100%; margin-top:5px; padding:12px;" id="sgAddBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <div class="folders-section" style="background: #e0f2fe; border-color:#bfdbfe;">
                        <div class="sg-folders-header">
                            <h4 style="color:#1e3a8a; margin:0;">üìÇ –ú–æ–∏ –ø–∞–ø–∫–∏</h4>
                        </div>
                        <div id="sgFoldersList"></div>
                    </div>
                </div>

                <div id="sg-view-carousel" style="display:none;">
                    <div class="sg-back-btn" id="sgBackBtn"><span>‚Üê</span> –ù–∞–∑–∞–¥ –∫ –ø–∞–ø–∫–∞–º</div>
                    <h3 id="sgActiveFolderName" style="text-align:center; margin:0 0 15px 0; font-size:1.2em; color:#333;">–ü–∞–ø–∫–∞</h3>
                    
                    <div class="sg-carousel">
                        <div class="sg-arrow-btn" id="sgPrevBtn">‚ùÆ</div>
                        <div class="sg-display-area">
                            <div class="sg-item-name" id="sgCarouselName">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                            <svg id="sgCarouselSvg"></svg>
                            <div class="sg-item-counter" id="sgCarouselCounter">0 / 0</div>
                        </div>
                        <div class="sg-arrow-btn" id="sgNextBtn">‚ùØ</div>
                    </div>

                    <div class="folder-actions-row" style="margin-top:25px; display:flex; justify-content:center; gap:10px;">
                        <button class="btn btn-warning btn-sm" id="sgRenameFolderBtn">‚úèÔ∏è –ò–º—è –ø–∞–ø–∫–∏</button>
                        <button class="btn btn-danger btn-sm" id="sgDeleteFolderBtn">üóëÔ∏è –£–¥. –ø–∞–ø–∫—É</button>
                    </div>
                    <div style="text-align:center; margin-top:15px;">
                        <button class="btn btn-outline btn-sm" id="sgDeleteItemBtn" style="color:#ef4444; border-color:#ef4444;">‚ùå –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π</button>
                    </div>
                </div>
            </div>
            
            <div id="tab-weightcarousel" class="tab-content">
                <div class="folders-section">
                    <h4>üìÅ –ü–∞–ø–∫–∏ —Å –±–∞—Ä–∫–æ–¥–∞–º–∏ (–í–µ—Å–æ–≤—ã–µ)</h4>
                    <div class="folder-list" id="wcFolderList"><div class="empty-state">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–∞–ø–æ–∫</div></div>
                    <div class="folder-actions-row" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center;">
                        <button class="btn btn-purple btn-sm" id="wc-run-folder">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                        <button class="btn btn-warning btn-sm" id="wc-rename-folder">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" id="wc-delete-folder">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="weight-carousel-form">
                    <div class="form-group">
                        <label for="wcFolderName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏</label>
                        <input type="text" id="wcFolderName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—ã—Ä—ã, –ö–æ–ª–±–∞—Å—ã...">
                    </div>
                    <label style="display:block; font-size:0.85em; font-weight:600; color:#333; margin-bottom:6px;">–ü—Ä–µ—Ñ–∏–∫—Å—ã —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤:</label>
                    <div class="prefix-checkboxes">
                        <label class="prefix-checkbox"><input type="checkbox" id="wcPrefix77" checked><span class="prefix-label"><span class="prefix-code">77</span><span class="prefix-desc">CAS(16)</span></span></label>
                        <label class="prefix-checkbox"><input type="checkbox" id="wcPrefix22"><span class="prefix-label"><span class="prefix-code">22</span><span class="prefix-desc">EAN(13)</span></span></label>
                        <label class="prefix-checkbox"><input type="checkbox" id="wcPrefix49"><span class="prefix-label"><span class="prefix-code">49</span><span class="prefix-desc">C128(19)</span></span></label>
                    </div>
                    <div class="form-group">
                        <label for="wcProductCode">–ö–æ–¥—ã —Ç–æ–≤–∞—Ä–æ–≤ (PLU)</label>
                        <textarea id="wcProductCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥—ã —Ç–æ–≤–∞—Ä–æ–≤:
1234
5678" style="width:100%; height:70px; padding:10px;"></textarea>
                    </div>
                    
                    <div id="group-discount-section" class="discount-section d-none">
                        <label style="font-weight:700; color:#7c3aed;">üè∑Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–∏–¥–∫–∏ (–¥–ª—è –º–∞—Å–∫–∏ 49)</label>
                        <div class="weight-mode-switch" style="margin-top:8px;">
                            <label class="weight-mode-label"><input type="radio" name="discountMode" value="fixed" checked onchange="toggleDiscountMode()">üîí –§–∏–∫—Å.</label>
                            <label class="weight-mode-label"><input type="radio" name="discountMode" value="random" onchange="toggleDiscountMode()">üé≤ Random</label>
                        </div>
                        
                        <div id="disc-fixed-group">
                            <input type="number" id="wcDiscount" placeholder="00" value="0" min="0" max="99">
                            <div class="hint">–í–≤–µ–¥–∏—Ç–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π % —Å–∫–∏–¥–∫–∏</div>
                        </div>
                        <div id="disc-random-group" class="d-none">
                            <div class="weight-range-row">
                                <input type="number" id="wcDiscMin" placeholder="–ú–∏–Ω" value="5">
                                <span>‚Äî</span>
                                <input type="number" id="wcDiscMax" placeholder="–ú–∞–∫—Å" value="30">
                            </div>
                            <div class="hint">–î–∏–∞–ø–∞–∑–æ–Ω —Å–ª—É—á–∞–π–Ω–æ–π —Å–∫–∏–¥–∫–∏ (%)</div>
                        </div>
                    </div>

                    <hr class="weight-divider">
                    <label style="font-weight:700;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ—Å–∞:</label>
                    <div class="weight-mode-switch">
                        <label class="weight-mode-label"><input type="radio" name="weightMode" value="random" checked onchange="toggleWeightMode()">üé≤ Random</label>
                        <label class="weight-mode-label"><input type="radio" name="weightMode" value="fixed" onchange="toggleWeightMode()">‚öì –§–∏–∫—Å.</label>
                    </div>
                    <div class="form-group" id="group-random-weight">
                        <label>–î–∏–∞–ø–∞–∑–æ–Ω –≤–µ—Å–∞ (–≥—Ä–∞–º–º—ã)</label>
                        <div class="weight-range-row"><input type="number" id="wcWeightMin" placeholder="–ú–∏–Ω" value="150"><span>‚Äî</span><input type="number" id="wcWeightMax" placeholder="–ú–∞–∫—Å" value="8000"></div>
                    </div>
                    <div class="form-group d-none" id="group-fixed-weight">
                        <label>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–µ—Å (–≥—Ä–∞–º–º—ã)</label>
                        <input type="number" id="wcFixedWeight" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 500" value="500" style="border-color:var(--purple); background:#fdf4ff;">
                    </div>
                    <div class="form-group">
                        <label for="wcVariations" id="wcVariationsLabel">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞—Ü–∏–π (—à—Ç)</label>
                        <input type="number" id="wcVariations" placeholder="–°–∫–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" value="10" min="1" max="100">
                        <div class="hint" id="wcVariationsHint">–°–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Å–æ–≤ —Å–æ–∑–¥–∞—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ PLU</div>
                    </div>
                    <div class="controls"><button class="btn btn-purple" id="wcAddToCarousel">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞–ø–∫—É</button></div>
                </div>
                <div class="bulk-actions">
                    <span style="flex:1; font-size:0.8em; color:#854d0e;">–í –ø–∞–ø–∫–µ: <strong id="wc-items-count">0</strong> —à—Ç. <span id="wc-current-folder-name"></span></span>
                    <button class="btn btn-outline btn-sm" id="wc-select-all">‚úì –í—Å–µ</button>
                    <button class="btn btn-outline btn-sm" id="wc-deselect-all">‚úï –°–Ω—è—Ç—å</button>
                    <button class="btn btn-danger btn-sm" id="wc-clear-selected">üóëÔ∏è</button>
                </div>
                <div class="weight-items-list" id="wcItemsList"></div>
                <div class="rotation-controls" id="wc-rotation-controls">
                    <div class="rotation-status" id="wc-rotation-status">–°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã</div>
                    <div style="margin-top:10px; display:flex; justify-content:center; gap:10px;">
                        <button class="btn btn-success btn-sm" id="wc-start-btn">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                        <button class="btn btn-warning btn-sm" id="wc-stop-btn" style="display:none;">‚èπÔ∏è –°—Ç–æ–ø</button>
                    </div>
                </div>
                <div class="barcode-carousel-display" id="wcCarouselDisplay" style="display:none;">
                    <div class="barcode-info" id="wcBarcodeInfo">-</div>
                    <div class="barcode-text" id="wcBarcodeText">-</div>
                    <svg id="wcBarcodeSvg"></svg>
                    <div class="carousel-counter" id="wcCarouselCounter">1 / 1</div>
                </div>
                <div class="interval-selector">
                    <label style="width:100%; text-align:center; color:#666; font-size:0.8em; margin-bottom:5px;">‚è±Ô∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª (—Å–µ–∫):</label>
                    <button class="wc-interval-btn" data-interval="0.5">0.5</button>
                    <button class="wc-interval-btn active" data-interval="0.7">0.7</button>
                    <button class="wc-interval-btn" data-interval="1">1</button>
                    <button class="wc-interval-btn" data-interval="2">2</button>
                    <input type="number" id="wc-custom-interval" class="custom-interval-input" placeholder="..." step="0.1" min="0.1" value="0.7">
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/bwip-js@3.0.4/dist/bwip-js-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <script>
    function toggleWeightMode() {
        var mode = document.querySelector('input[name="weightMode"]:checked').value;
        var randomGroup = document.getElementById('group-random-weight');
        var fixedGroup = document.getElementById('group-fixed-weight');
        var label = document.getElementById('wcVariationsLabel');
        var hint = document.getElementById('wcVariationsHint');
        
        if (mode === 'fixed') {
            randomGroup.classList.add('d-none');
            fixedGroup.classList.remove('d-none');
            label.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–æ–≤ (—à—Ç)';
            hint.textContent = '–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —ç—Ç–æ—Ç –≤–µ—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ PLU';
        } else {
            randomGroup.classList.remove('d-none');
            fixedGroup.classList.add('d-none');
            label.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞—Ü–∏–π (—à—Ç)';
            hint.textContent = '–°–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Å–æ–≤ —Å–æ–∑–¥–∞—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ PLU';
        }
    }

    function toggleDiscountMode() {
        var mode = document.querySelector('input[name="discountMode"]:checked').value;
        var fixedGroup = document.getElementById('disc-fixed-group');
        var randomGroup = document.getElementById('disc-random-group');
        
        if (mode === 'fixed') {
            fixedGroup.classList.remove('d-none');
            randomGroup.classList.add('d-none');
        } else {
            fixedGroup.classList.add('d-none');
            randomGroup.classList.remove('d-none');
        }
    }

    function toggleDiscountVisibility() {
        var is49Checked = document.getElementById('wcPrefix49').checked;
        var discountSection = document.getElementById('group-discount-section');
        if (is49Checked) {
            discountSection.classList.remove('d-none');
        } else {
            discountSection.classList.add('d-none');
        }
    }

    (function() {
        'use strict';
        var STORAGE_KEY = 'barcode_gen_v4';
        
        // --- GLOBAL STATE ---
        var state = { 
            timerValue: 0.7, 
            remaining: 0.7, 
            timerInterval: null, 
            savedItems: [], 
            selectedTemplate: 'type1', 
            isRotating: false, 
            rotationList: [], 
            rotationIndex: 0, 
            
            // Weight Carousel State
            wcFolders: [], 
            wcSelectedFolderId: null, 
            wcTimerValue: 0.7, 
            wcRemaining: 0.7, 
            wcTimerInterval: null, 
            wcIsRotating: false, 
            wcRotationIndex: 0, 
            wcRotationItems: [],

            // Simple Gen Folders State
            sgFolders: [],
            sgSelectedFolderId: null,
            sgCarouselIndex: 0,
            sgIsNewFolderMode: false 
        };
        
        function loadData() { try { var data = localStorage.getItem(STORAGE_KEY); if (data) { var parsed = JSON.parse(data); state.savedItems = parsed.savedItems || []; state.wcFolders = parsed.wcFolders || []; state.sgFolders = parsed.sgFolders || []; } } catch (e) { console.error(e); } }
        function saveData() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ savedItems: state.savedItems, wcFolders: state.wcFolders, sgFolders: state.sgFolders })); } catch (e) { console.error(e); } }
        
        // --- BACKUP FUNCTIONS ---
        function exportData() {
            var dataToExport = {
                savedItems: state.savedItems,
                wcFolders: state.wcFolders,
                sgFolders: state.sgFolders,
                timestamp: new Date().toISOString()
            };
            var json = JSON.stringify(dataToExport, null, 2);
            var blob = new Blob([json], {type: "application/json"});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = "generator_backup_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    if (confirm('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                        state.savedItems = data.savedItems || [];
                        state.wcFolders = data.wcFolders || [];
                        state.sgFolders = data.sgFolders || [];
                        saveData();
                        alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
                        location.reload();
                    }
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON —Ñ–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        function getRandomChar() { var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"; return chars.charAt(Math.floor(Math.random() * chars.length)); }
        function generateSerial(prefix, length) { var s = prefix || ''; var targetLen = length || 13; for (var i = s.length; i < targetLen; i++) s += getRandomChar(); return s; }
        function randomDigits(len) { var s = ''; for (var i = 0; i < len; i++) s += Math.floor(Math.random() * 10); return s; }
        function randomHex(len) { var hex = '0123456789ABCDEF'; var s = ''; for (var i = 0; i < len; i++) s += hex[Math.floor(Math.random() * 16)]; return s; }
        function randomBase64(len) { var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'; var s = ''; for (var i = 0; i < len; i++) s += chars[Math.floor(Math.random() * 64)]; return s; }
        function padBarcode(b) { b = b.replace(/\D/g, ''); while (b.length < 14) b = '0' + b; return b.slice(0, 14); }

        var templates = {
            type1: { name: '–¢–∏–ø 1 (–¢–∞–±–∞–∫/–í–æ–¥–∞)', generate: function(barcode) { var gs = String.fromCharCode(29); var gtin = padBarcode(barcode); var serial = generateSerial('0', 7); var crypto = randomBase64(4).substring(0, 4); return '01' + gtin + '21' + serial + gs + '93' + crypto; } },
            type2: { name: '–¢–∏–ø 2 (–û–¥–µ–∂–¥–∞/–û–±—É–≤—å)', generate: function(barcode) { var gs = String.fromCharCode(29); var gtin = padBarcode(barcode); var serial = generateSerial('5', 13); var key = randomHex(4); var code = randomBase64(44); return '01' + gtin + '21' + serial + gs + '91' + key + gs + '92' + code; } }
        };
        
        function generateDemoCode() { var demoGTIN = '0' + randomDigits(13); var tmpl = templates[state.selectedTemplate]; return tmpl.generate(demoGTIN); }
        
        function drawDataMatrix(code) {
            var container = document.getElementById('datamatrix-container');
            if (!container) return;
            container.innerHTML = '';
            try {
                if (typeof bwipjs === 'undefined') { container.innerHTML = '<div class="error-msg">–û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ bwip-js –Ω–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ–¥!</div>'; return; }
                var canvas = document.createElement('canvas');
                bwipjs.toCanvas(canvas, { bcid: 'datamatrix', text: code, scale: 4, padding: 2 });
                container.appendChild(canvas);
            } catch (e) { container.innerHTML = '<div class="error-msg">–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (bwip-js)</div>'; }
        }
        
        function generateAndDisplay() {
            var code, barcode, tmplName;
            if (state.isRotating && state.rotationList.length > 0) {
                var item = state.rotationList[state.rotationIndex];
                barcode = item.barcode;
                var tmpl = templates[item.template] || templates.type1;
                tmplName = tmpl.name;
                code = tmpl.generate(barcode);
                state.rotationIndex = (state.rotationIndex + 1) % state.rotationList.length;
                showCodeInfo(barcode, tmplName, state.rotationIndex, state.rotationList.length);
                updateModeBadge(true, state.rotationList.length);
            } else {
                code = generateDemoCode();
                hideCodeInfo();
                updateModeBadge(false, state.savedItems.length);
            }
            drawDataMatrix(code);
            var codeEl = document.getElementById('current-code');
            if (codeEl) { codeEl.textContent = code; codeEl.className = 'flash'; setTimeout(function() { codeEl.className = ''; }, 300); }
        }
        
        function showCodeInfo(barcode, tmplName, idx, total) {
            var el = document.getElementById('code-info'); if (el) el.style.display = 'block';
            var bc = document.getElementById('info-barcode'); if (bc) bc.textContent = barcode;
            var tmpl = document.getElementById('info-template'); if (tmpl) tmpl.textContent = tmplName;
            var counter = document.getElementById('info-counter'); if (counter) counter.textContent = (idx === 0 ? total : idx) + ' / ' + total;
        }
        function hideCodeInfo() { var el = document.getElementById('code-info'); if (el) el.style.display = 'none'; }
        function updateModeBadge(isRotation, count) {
            var badge = document.getElementById('mode-badge'); if (!badge) return;
            if (isRotation) { badge.textContent = 'üîÑ –†–æ—Ç–∞—Ü–∏—è: ' + count + ' GTIN'; badge.className = 'mode-badge list'; badge.style.display = 'inline-block'; } 
            else { badge.textContent = 'üì¶ –î–µ–º–æ-—Ä–µ–∂–∏–º'; badge.className = 'mode-badge default'; badge.style.display = 'none'; }
        }
        
        // --- CORE TIMER LOGIC ---
        function startTimer() { 
            stopTimer(); 
            state.remaining = state.timerValue; 
            updateCountdown(); 
            toggleDmPlayState(true); // Update UI to Play State
            state.timerInterval = setInterval(function() { 
                state.remaining -= 0.1; 
                if (state.remaining <= 0.05) { 
                    generateAndDisplay(); 
                    state.remaining = state.timerValue; 
                } 
                updateCountdown(); 
            }, 100); 
        }

        function stopTimer() { 
            if (state.timerInterval) { 
                clearInterval(state.timerInterval); 
                state.timerInterval = null; 
            }
            toggleDmPlayState(false); // Update UI to Pause State
        }

        function updateCountdown() { 
            var el = document.getElementById('countdown'); 
            if (el) el.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ' + (state.remaining > 0 ? state.remaining : 0).toFixed(1) + ' —Å–µ–∫'; 
        }

        // --- NEW MANUAL DM NAVIGATION ---
        function toggleDmPlayState(isPlaying) {
            var playBtn = document.getElementById('dm-play-btn');
            var pauseBtn = document.getElementById('dm-pause-btn');
            var prevBtn = document.getElementById('dm-prev-btn');
            var nextBtn = document.getElementById('dm-next-btn');
            var timerEl = document.getElementById('timer');

            if (isPlaying) {
                if(playBtn) playBtn.style.display = 'none';
                if(pauseBtn) pauseBtn.style.display = 'inline-flex';
                // Hide side arrows
                if(prevBtn) prevBtn.style.display = 'none';
                if(nextBtn) nextBtn.style.display = 'none';
                if(timerEl) timerEl.style.opacity = '1';
            } else {
                if(playBtn) playBtn.style.display = 'inline-flex';
                if(pauseBtn) pauseBtn.style.display = 'none';
                // Show side arrows
                if(prevBtn) prevBtn.style.display = 'flex';
                if(nextBtn) nextBtn.style.display = 'flex';
                if(timerEl) timerEl.style.opacity = '0.5';
            }
        }

        function dmManualNext() {
            generateAndDisplay();
        }

        function dmManualPrev() {
            if (state.isRotating && state.rotationList.length > 0) {
                var len = state.rotationList.length;
                state.rotationIndex = (state.rotationIndex - 2 + len) % len;
                generateAndDisplay();
            } else {
                generateAndDisplay(); 
            }
        }
        
        function updateSelectedCount() { var count = state.savedItems.filter(function(x) { return x.active; }).length; var el = document.getElementById('selected-count'); if (el) el.textContent = count; }
        
        function renderSavedList() {
            var container = document.getElementById('saved-list'); if (!container) return;
            if (state.savedItems.length === 0) { container.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö GTIN</div>'; updateSelectedCount(); return; }
            var html = '';
            for (var i = 0; i < state.savedItems.length; i++) {
                var item = state.savedItems[i];
                var tmpl = templates[item.template] || templates.type1;
                html += '<div class="saved-item' + (item.active ? ' active' : '') + '" data-id="' + item.id + '"><div class="info"><div class="barcode">' + item.barcode + '</div><div class="template-name">' + tmpl.name + '</div></div><div class="actions"><button class="btn btn-sm ' + (item.active ? 'btn-success' : 'btn-outline') + '" data-action="toggle">' + (item.active ? '‚úì' : '‚óã') + '</button><button class="btn btn-sm btn-danger" data-action="delete">‚úï</button></div></div>';
            }
            container.innerHTML = html;
            var items = container.querySelectorAll('.saved-item');
            for (var j = 0; j < items.length; j++) {
                (function(el) {
                    var id = el.getAttribute('data-id');
                    var buttons = el.querySelectorAll('button');
                    for (var k = 0; k < buttons.length; k++) {
                        (function(btn) {
                            btn.onclick = function(e) { e.stopPropagation(); var action = btn.getAttribute('data-action'); if (action === 'toggle') toggleItem(id); if (action === 'delete') deleteItem(id); };
                        })(buttons[k]);
                    }
                })(items[j]);
            }
            updateSelectedCount(); updateRotationStatus();
        }
        
        function addBarcodes(input) {
            var lines = input.split('\n'); var added = 0;
            for (var i = 0; i < lines.length; i++) {
                var barcode = lines[i].trim().replace(/\D/g, '');
                if (barcode.length >= 8) { state.savedItems.push({ id: Date.now().toString() + '_' + i, barcode: barcode, template: state.selectedTemplate, active: true }); added++; }
            }
            if (added > 0) { saveData(); renderSavedList(); } return added;
        }
        
        function toggleItem(id) { for (var i = 0; i < state.savedItems.length; i++) { if (state.savedItems[i].id === id) { state.savedItems[i].active = !state.savedItems[i].active; break; } } saveData(); renderSavedList(); }
        function deleteItem(id) { state.savedItems = state.savedItems.filter(function(x) { return x.id !== id; }); saveData(); renderSavedList(); }
        function selectAll() { for (var i = 0; i < state.savedItems.length; i++) state.savedItems[i].active = true; saveData(); renderSavedList(); }
        function deselectAll() { for (var i = 0; i < state.savedItems.length; i++) state.savedItems[i].active = false; saveData(); renderSavedList(); }
        function clearAll() { if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ GTIN?')) { state.savedItems = []; saveData(); renderSavedList(); stopRotation(); } }
        
        function updateRotationStatus() {
            var el = document.getElementById('rotation-status'); var activeItems = state.savedItems.filter(function(x) { return x.active; });
            if (el) { if (state.isRotating) el.textContent = 'üîÑ –†–æ—Ç–∞—Ü–∏—è: ' + state.rotationList.length + ' GTIN'; else if (activeItems.length > 0) el.textContent = '‚úì –í—ã–±—Ä–∞–Ω–æ: ' + activeItems.length + ' GTIN'; else el.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ GTIN –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏'; }
            var controls = document.getElementById('rotation-controls'); if (controls) controls.className = 'rotation-controls' + (state.isRotating ? ' active' : '');
        }
        
        function startRotation() {
            var activeItems = state.savedItems.filter(function(x) { return x.active; });
            if (activeItems.length === 0) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω GTIN!'); return; }
            state.rotationList = activeItems; state.rotationIndex = 0; state.isRotating = true;
            switchToTab('datamatrix');
            document.getElementById('start-btn').style.display = 'none'; document.getElementById('stop-btn').style.display = 'inline-flex';
            updateRotationStatus(); generateAndDisplay(); startTimer();
        }
        
        function stopRotation() {
            state.isRotating = false; state.rotationList = []; state.rotationIndex = 0;
            document.getElementById('start-btn').style.display = 'inline-flex'; document.getElementById('stop-btn').style.display = 'none';
            updateRotationStatus(); hideCodeInfo(); updateModeBadge(false, state.savedItems.length);
        }
        
        var barcodeConfigs = {
            code128_19_piece: { prefix: "47", fields: [{ name: "productCode", label: "–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ (9 —Ü–∏—Ñ—Ä)", length: 9 }, { name: "discount", label: "–°–∫–∏–¥–∫–∞ (2 —Ü–∏—Ñ—Ä—ã)", length: 2 }, { name: "quantity", label: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (5 —Ü–∏—Ñ—Ä)", length: 5 }], totalLength: 19, controlPos: 19 },
            code128_19_weight: { prefix: "49", fields: [{ name: "productCode", label: "–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ (9 —Ü–∏—Ñ—Ä)", length: 9 }, { name: "discount", label: "–°–∫–∏–¥–∫–∞ (2 —Ü–∏—Ñ—Ä—ã)", length: 2 }, { name: "weight", label: "–í–µ—Å (5 —Ü–∏—Ñ—Ä)", length: 5 }], totalLength: 19, controlPos: 19 },
            code128_19_price: { prefix: "44", fields: [{ name: "productCode", label: "–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ (9 —Ü–∏—Ñ—Ä)", length: 9 }, { name: "price", label: "–¶–µ–Ω–∞ (7 —Ü–∏—Ñ—Ä)", length: 7 }], totalLength: 19, controlPos: 19 },
            code128_16_cas: { prefix: "77", fields: [{ name: "productCode", label: "–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ (6 —Ü–∏—Ñ—Ä)", length: 6 }, { name: "weight", label: "–í–µ—Å (7 —Ü–∏—Ñ—Ä)", length: 7 }], totalLength: 16, controlPos: 16 },
            ean13_weight: { prefix: "22", fields: [{ name: "productCode", label: "–ö–æ–¥ —Ç–æ–≤–∞—Ä–∞ (5 —Ü–∏—Ñ—Ä)", length: 5 }, { name: "weight", label: "–í–µ—Å (5 —Ü–∏—Ñ—Ä)", length: 5 }], totalLength: 13, controlPos: 13 }
        };
        
        function renderBarcodeFields() {
            var container = document.getElementById('barcodeParams'); var typeSelect = document.getElementById('barcodeType'); if (!container || !typeSelect) return;
            container.innerHTML = ''; var cfg = barcodeConfigs[typeSelect.value];
            for (var i = 0; i < cfg.fields.length; i++) {
                var f = cfg.fields[i]; var div = document.createElement('div'); div.className = 'form-group';
                div.innerHTML = '<label for="' + f.name + '">' + f.label + '</label><input type="text" id="' + f.name + '" placeholder="–¥–æ ' + f.length + ' —Ü–∏—Ñ—Ä"><div class="error-text" id="' + f.name + '-error"></div>';
                container.appendChild(div);
            }
        }
        
        function padZeros(v, len) { v = v.replace(/\D/g, ''); return v.padStart(len, '0'); }
        function calcControlCore(code) { return code.split('').filter(function(ch) { return /\d/.test(ch); }).map(function(d) { return +d; }).reduce(function(a, b) { return a + b; }, 0) % 10; }
        function calcControlEAN13(code) { var digs = code.split('').map(function(d) { return +d; }); var sum = 0; for (var i = 0; i < digs.length; i++) { sum += digs[i] * (i % 2 ? 3 : 1); } return (10 - (sum % 10)) % 10; }
        
        function generateBarcodeCode() {
            var typeSelect = document.getElementById('barcodeType'); var cfg = barcodeConfigs[typeSelect.value];
            for (var i = 0; i < cfg.fields.length; i++) { var errEl = document.getElementById(cfg.fields[i].name + '-error'); if (errEl) errEl.textContent = ''; }
            var code = cfg.prefix;
            for (var j = 0; j < cfg.fields.length; j++) {
                var f = cfg.fields[j]; var inp = document.getElementById(f.name); var v = inp ? inp.value.trim().replace(/\D/g, '') : '';
                if (v.length > f.length) { var errEl = document.getElementById(f.name + '-error'); if (errEl) errEl.textContent = '–ù–µ –±–æ–ª–µ–µ ' + f.length + ' —Ü–∏—Ñ—Ä'; return null; }
                code += padZeros(v, f.length);
            }
            var ctrl; if (typeSelect.value === 'code128_16_cas') ctrl = '0'; else if (typeSelect.value === 'ean13_weight') ctrl = calcControlEAN13(code).toString(); else ctrl = calcControlCore(code).toString();
            code += ctrl; return code;
        }
        
        function drawBarcode(txt) {
            var svg = document.getElementById('barcodeSvg'); var typeSelect = document.getElementById('barcodeType'); if (!svg) return; svg.innerHTML = '';
            try {
                if (typeof JsBarcode === 'undefined') { var resultEl = document.getElementById('barcodeResult'); if (resultEl) resultEl.innerHTML += '<div class="error-msg" style="color:red">–û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ JsBarcode –Ω–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –∫–æ–¥!</div>'; return; }
                JsBarcode(svg, txt, { format: typeSelect.value === 'ean13_weight' ? 'EAN13' : 'CODE128', height: 80, displayValue: true, fontSize: 14, margin: 10 });
            } catch (e) {
                console.error(e); try { JsBarcode(svg, txt, { format: 'CODE128', height: 80, displayValue: true, fontSize: 14, margin: 10 }); } catch(err) {}
            }
        }
        
        function handleGenerateBarcode() {
            var code = generateBarcodeCode(); if (!code) return;
            var simErr = document.getElementById('simulateError'); var typeSelect = document.getElementById('barcodeType');
            if (simErr && simErr.checked && typeSelect.value !== 'code128_16_cas') {
                var cfg = barcodeConfigs[typeSelect.value]; var pos = cfg.controlPos - 1; var real = code[pos]; var bad = Math.floor(Math.random() * 10).toString(); while (bad === real) bad = Math.floor(Math.random() * 10).toString(); code = code.slice(0, pos) + bad;
            }
            var resultEl = document.getElementById('barcodeResult'); var textEl = document.getElementById('barcodeText');
            if (resultEl) resultEl.style.display = 'block'; if (textEl) textEl.textContent = code; drawBarcode(code);
        }

        // ==========================================
        //  SIMPLE GEN LOGIC
        // ==========================================
        function handleSimpleGenerator() {
            var type = document.getElementById('sgType').value;
            var val = document.getElementById('sgValue').value.trim();
            var svg = document.getElementById('sgSvg');
            var container = document.getElementById('sgPreviewContainer');

            if (!val) {
                svg.style.display = 'none';
                return;
            }
            
            var displayVal = val;
            if (type === 'EAN13' && val.length === 12 && /^\d+$/.test(val)) {
                displayVal += calcControlEAN13(val);
            }

            svg.innerHTML = '';
            svg.style.display = 'block';

            try {
                if (typeof JsBarcode === 'undefined') return;
                JsBarcode(svg, displayVal, {
                    format: (type === 'CODE128') ? 'CODE128' : type,
                    height: 50,
                    displayValue: true,
                    margin: 5,
                    fontSize: 14
                });
            } catch (e) {
                svg.style.display = 'none';
            }
        }

        function renderSGFolders() {
            var container = document.getElementById('sgFoldersList');
            var select = document.getElementById('sgFolderSelect');
            
            if (container) {
                if (state.sgFolders.length === 0) {
                    container.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–∞–ø–æ–∫. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</div>';
                } else {
                    var html = '';
                    for (var i = 0; i < state.sgFolders.length; i++) {
                        var f = state.sgFolders[i];
                        html += '<div class="sg-folder-row" onclick="openSGFolder(\''+f.id+'\')">';
                        html += '<div style="font-size:1.5em; margin-right:10px;">üìÇ</div>';
                        html += '<div style="flex:1"><div><b>'+f.name+'</b></div><div style="font-size:0.8em; color:#666">'+f.items.length+' —à—Ç.</div></div>';
                        html += '<div style="color:#aaa">‚ùØ</div>';
                        html += '</div>';
                    }
                    container.innerHTML = html;
                }
            }

            if (select) {
                var opts = '';
                if (state.sgFolders.length === 0) {
                    opts = '<option disabled selected>–ù–µ—Ç –ø–∞–ø–æ–∫</option>';
                    if (!state.sgIsNewFolderMode) toggleSGFolderMode(true);
                } else {
                    for(var k=0; k<state.sgFolders.length; k++) {
                        opts += '<option value="' + state.sgFolders[k].name + '">' + state.sgFolders[k].name + '</option>';
                    }
                    if (state.sgIsNewFolderMode && document.getElementById('sgFolderInput').value === '') {
                        toggleSGFolderMode(false);
                    }
                }
                select.innerHTML = opts;
            }
        }
        
        function toggleSGFolderMode(forceNew) {
            var select = document.getElementById('sgFolderSelect');
            var input = document.getElementById('sgFolderInput');
            var btn = document.getElementById('sgFolderModeBtn');
            
            var isNew = (typeof forceNew !== 'undefined') ? forceNew : !state.sgIsNewFolderMode;
            state.sgIsNewFolderMode = isNew;
            
            if (isNew) {
                select.classList.add('d-none');
                input.classList.remove('d-none');
                input.focus();
                btn.textContent = '‚ò∞'; 
                btn.title = "–í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞";
                btn.classList.remove('btn-purple');
                btn.classList.add('btn-secondary');
            } else {
                select.classList.remove('d-none');
                input.classList.add('d-none');
                btn.textContent = 'Ôºã'; 
                btn.title = "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–∞–ø–∫—É";
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-purple');
            }
        }

        function saveToSGFolder() {
            var val = document.getElementById('sgValue').value.trim();
            var type = document.getElementById('sgType').value;
            var name = document.getElementById('sgName').value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
            
            var folderName;
            
            if (state.sgIsNewFolderMode || state.sgFolders.length === 0) {
                 folderName = document.getElementById('sgFolderInput').value.trim();
            } else {
                 folderName = document.getElementById('sgFolderSelect').value;
            }

            if (!val) return alert('–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞!');
            if (!folderName) return alert('–£–∫–∞–∂–∏—Ç–µ –∏–º—è –ø–∞–ø–∫–∏!');

            if (type === 'EAN13' && val.length === 12 && /^\d+$/.test(val)) {
                val += calcControlEAN13(val);
            }

            var folder = state.sgFolders.find(function(f){ return f.name.toLowerCase() === folderName.toLowerCase(); });
            if (!folder) {
                folder = { id: 'sgf_' + Date.now(), name: folderName, items: [] };
                state.sgFolders.push(folder);
            }

            folder.items.push({
                id: 'sgi_' + Date.now(),
                code: val,
                type: type,
                name: name
            });

            saveData();
            renderSGFolders();
            
            document.getElementById('sgValue').value = '';
            document.getElementById('sgName').value = '';
            document.getElementById('sgSvg').style.display = 'none';

            if (state.sgIsNewFolderMode) {
                 document.getElementById('sgFolderInput').value = '';
                 toggleSGFolderMode(false);
                 setTimeout(function(){ 
                     document.getElementById('sgFolderSelect').value = folder.name; 
                 }, 50);
            }
            alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ø–∞–ø–∫—É: ' + folder.name);
        }

        window.openSGFolder = function(id) {
            state.sgSelectedFolderId = id;
            var folder = state.sgFolders.find(function(f){ return f.id === id; });
            if(!folder) return;

            document.getElementById('sg-view-list').style.display = 'none';
            document.getElementById('sg-view-carousel').style.display = 'block';
            
            document.getElementById('sgActiveFolderName').textContent = folder.name;
            state.sgCarouselIndex = 0;
            renderSGCarouselItem();
        }

        function closeSGFolder() {
            state.sgSelectedFolderId = null;
            document.getElementById('sg-view-carousel').style.display = 'none';
            document.getElementById('sg-view-list').style.display = 'block';
            renderSGFolders();
        }

        function renderSGCarouselItem() {
            var folder = state.sgFolders.find(function(f){ return f.id === state.sgSelectedFolderId; });
            if (!folder || folder.items.length === 0) {
                document.getElementById('sgCarouselName').textContent = '–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞';
                document.getElementById('sgCarouselSvg').innerHTML = '';
                document.getElementById('sgCarouselCounter').textContent = '0 / 0';
                return;
            }

            if (state.sgCarouselIndex < 0) state.sgCarouselIndex = folder.items.length - 1;
            if (state.sgCarouselIndex >= folder.items.length) state.sgCarouselIndex = 0;

            var item = folder.items[state.sgCarouselIndex];
            document.getElementById('sgCarouselName').textContent = item.name;
            document.getElementById('sgCarouselCounter').textContent = (state.sgCarouselIndex + 1) + ' / ' + folder.items.length;
            
            var svg = document.getElementById('sgCarouselSvg');
            svg.innerHTML = '';
            try {
                JsBarcode(svg, item.code, {
                    format: (item.type === 'CODE128') ? 'CODE128' : item.type,
                    height: 80,
                    displayValue: true,
                    margin: 10,
                    fontSize: 16
                });
            } catch(e) {}
        }

        function sgNext() { state.sgCarouselIndex++; renderSGCarouselItem(); }
        function sgPrev() { state.sgCarouselIndex--; renderSGCarouselItem(); }
        
        function sgDeleteFolder() {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–∞–ø–∫—É –∏ –≤—Å–µ —à—Ç—Ä–∏—Ö–∫–æ–¥—ã –≤–Ω—É—Ç—Ä–∏?')) return;
            state.sgFolders = state.sgFolders.filter(function(f){ return f.id !== state.sgSelectedFolderId; });
            saveData();
            closeSGFolder();
        }
        
        function sgRenameFolder() {
            var folder = state.sgFolders.find(function(f){ return f.id === state.sgSelectedFolderId; });
            var newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏:', folder.name);
            if(newName && newName.trim()) {
                folder.name = newName.trim();
                saveData();
                document.getElementById('sgActiveFolderName').textContent = folder.name;
            }
        }
        
        function sgDeleteItem() {
            var folder = state.sgFolders.find(function(f){ return f.id === state.sgSelectedFolderId; });
            if(!folder || folder.items.length === 0) return;
            if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à—Ç—Ä–∏—Ö–∫–æ–¥?')) return;
            
            folder.items.splice(state.sgCarouselIndex, 1);
            saveData();
            if(state.sgCarouselIndex >= folder.items.length) state.sgCarouselIndex = folder.items.length - 1;
            renderSGCarouselItem();
        }

        // --- WEIGHT CAROUSEL LOGIC ---
        function generateWeightBarcode(prefix, productCode, weightGrams, discountVal) {
            var code, ctrl;
            if (prefix === '77') { 
                var pluPadded = padZeros(productCode, 6); var weightPadded = padZeros(weightGrams.toString(), 7); 
                code = '77' + pluPadded + weightPadded; ctrl = '0'; 
                return { code: code + ctrl, format: 'CODE128', weight: weightGrams, plu: pluPadded, prefix: '77' }; 
            }
            else if (prefix === '49') {
                var pluPadded = padZeros(productCode, 9);
                var weightPadded = padZeros(weightGrams.toString(), 5);
                var discountPadded = padZeros(discountVal.toString(), 2);
                var base = '49' + pluPadded + discountPadded + weightPadded;
                ctrl = calcControlCore(base).toString(); 
                return { code: base + ctrl, format: 'CODE128', weight: weightGrams, plu: pluPadded, prefix: '49', discount: discountVal };
            }
            else { 
                var pluPadded = padZeros(productCode, 5); var weightPadded = padZeros(weightGrams.toString(), 5); 
                code = '22' + pluPadded + weightPadded; ctrl = calcControlEAN13(code).toString(); 
                return { code: code + ctrl, format: 'EAN13', weight: weightGrams, plu: pluPadded, prefix: '22' }; 
            }
        }
        
        function generateRandomWeight(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        
        function getCurrentFolder() { if (!state.wcSelectedFolderId) return null; return state.wcFolders.find(function(f) { return f.id === state.wcSelectedFolderId; }); }
        function getCurrentFolderItems() { var folder = getCurrentFolder(); return folder ? folder.items : []; }
        
        function renderFolderList() {
            var container = document.getElementById('wcFolderList'); if (!container) return;
            if (state.wcFolders.length === 0) { container.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–∞–ø–æ–∫</div>'; return; }
            var html = '';
            for (var i = 0; i < state.wcFolders.length; i++) {
                var folder = state.wcFolders[i]; var itemCount = folder.items.length; var isSelected = folder.id === state.wcSelectedFolderId;
                html += '<div class="folder-item' + (isSelected ? ' selected' : '') + '" data-folder-id="' + folder.id + '"><div class="folder-icon">üìÅ</div><div class="folder-info"><div class="folder-name">' + escapeHtml(folder.name) + '</div><div class="folder-details">' + itemCount + ' —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</div></div></div>';
            }
            container.innerHTML = html;
            var items = container.querySelectorAll('.folder-item'); for (var j = 0; j < items.length; j++) { (function(el) { el.onclick = function() { selectFolder(el.getAttribute('data-folder-id')); }; })(items[j]); }
        }
        function escapeHtml(text) { var div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        
        function selectFolder(folderId) { state.wcSelectedFolderId = folderId; renderFolderList(); renderWeightCarouselList(); updateCurrentFolderName(); }
        function updateCurrentFolderName() { var el = document.getElementById('wc-current-folder-name'); var folder = getCurrentFolder(); if (el) { el.innerHTML = folder ? '<span class="current-folder-badge">üìÅ ' + escapeHtml(folder.name) + '</span>' : ''; } }
        
        function addToWeightCarousel() {
            var folderName = document.getElementById('wcFolderName').value.trim(); var productCodesRaw = document.getElementById('wcProductCode').value.trim(); var variations = parseInt(document.getElementById('wcVariations').value) || 10;
            var mode = document.querySelector('input[name="weightMode"]:checked').value;
            
            var use77 = document.getElementById('wcPrefix77').checked; 
            var use22 = document.getElementById('wcPrefix22').checked;
            var use49 = document.getElementById('wcPrefix49').checked;
            
            var discountMode = document.querySelector('input[name="discountMode"]:checked').value;
            var fixedDiscount = parseInt(document.getElementById('wcDiscount').value) || 0;
            var discMin = parseInt(document.getElementById('wcDiscMin').value) || 0;
            var discMax = parseInt(document.getElementById('wcDiscMax').value) || 0;
            if (discMin > discMax) { var temp = discMin; discMin = discMax; discMax = temp; }
            
            if (!use77 && !use22 && !use49) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Ñ–∏–∫—Å (77, 22 –∏–ª–∏ 49)!'); return; }
            var prefixes = []; if (use77) prefixes.push('77'); if (use22) prefixes.push('22'); if (use49) prefixes.push('49');
            
            var productCodes = productCodesRaw.split('\n').map(function(line) { return line.trim().replace(/\D/g, ''); }).filter(function(code) { return code.length > 0; });
            if (productCodes.length === 0) { alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥—ã —Ç–æ–≤–∞—Ä–æ–≤!'); return; }
            var weightMin = 0, weightMax = 0, fixedWeight = 0;
            if (mode === 'fixed') fixedWeight = parseInt(document.getElementById('wcFixedWeight').value) || 500;
            else { weightMin = parseInt(document.getElementById('wcWeightMin').value) || 150; weightMax = parseInt(document.getElementById('wcWeightMax').value) || 8000; if (weightMin >= weightMax) { alert('–ú–∏–Ω. –≤–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–Ω—å—à–µ –º–∞–∫—Å.!'); return; } }
            
            var baseId = Date.now().toString(); var allNewItems = [];
            for (var p = 0; p < productCodes.length; p++) {
                var productCode = productCodes[p];
                for (var i = 0; i < variations; i++) {
                    var currentWeight = (mode === 'fixed') ? fixedWeight : generateRandomWeight(weightMin, weightMax);
                    var currentDiscount = (discountMode === 'fixed') ? fixedDiscount : generateRandomWeight(discMin, discMax);
                    
                    for (var pr = 0; pr < prefixes.length; pr++) {
                        var prefix = prefixes[pr]; var itemBaseId = baseId + '_' + p + '_' + i + '_' + prefix; 
                        var barcode = generateWeightBarcode(prefix, productCode, currentWeight, currentDiscount);
                        allNewItems.push({ id: itemBaseId, code: barcode.code, format: barcode.format, plu: barcode.plu, weight: currentWeight, prefix: prefix, active: true, discount: (prefix === '49' ? currentDiscount : undefined) });
                    }
                }
            }
            var targetFolder;
            if (folderName) { targetFolder = state.wcFolders.find(function(f) { return f.name.toLowerCase() === folderName.toLowerCase(); }); if (!targetFolder) { targetFolder = { id: Date.now().toString() + '_folder', name: folderName, items: [] }; state.wcFolders.push(targetFolder); } }
            else if (state.wcSelectedFolderId) targetFolder = getCurrentFolder();
            else { var firstPlu = productCodes[0]; var autoName = (mode === 'fixed' ? 'FIX ' + fixedWeight + '–≥' : 'RND') + ' - PLU ' + firstPlu; if (productCodes.length > 1) autoName += ' (+' + (productCodes.length - 1) + ')'; targetFolder = { id: Date.now().toString() + '_folder', name: autoName, items: [] }; state.wcFolders.push(targetFolder); }
            
            targetFolder.items = targetFolder.items.concat(allNewItems); state.wcSelectedFolderId = targetFolder.id;
            saveData(); renderFolderList(); renderWeightCarouselList(); updateCurrentFolderName();
            document.getElementById('wcFolderName').value = ''; document.getElementById('wcProductCode').value = '';
            alert('–î–æ–±–∞–≤–ª–µ–Ω–æ ' + allNewItems.length + ' —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ –≤ –ø–∞–ø–∫—É "' + targetFolder.name + '"');
        }
        
        function renderWeightCarouselList() {
            var container = document.getElementById('wcItemsList'); if (!container) return;
            var items = getCurrentFolderItems(); var countEl = document.getElementById('wc-items-count'); if (countEl) countEl.textContent = items.length;
            if (items.length === 0) { container.innerHTML = '<div class="empty-state">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã</div>'; updateWCRotationStatus(); return; }
            var html = '';
            for (var i = 0; i < items.length; i++) {
                var item = items[i]; var weightDisplay = (item.weight / 1000).toFixed(3) + ' –∫–≥'; 
                var typeLabel = item.prefix === '77' ? 'CAS' : (item.prefix === '49' ? 'C128' : 'EAN');
                var discountLabel = (item.prefix === '49' && item.discount !== undefined) ? ' | –°–∫–∏–¥–∫–∞: ' + item.discount + '%' : '';
                html += '<div class="weight-item' + (item.active ? ' active' : '') + '" data-id="' + item.id + '"><div class="info"><div class="code">' + item.code + '</div><div class="details">PLU: ' + item.plu + ' | ' + weightDisplay + ' | ' + typeLabel + discountLabel + '</div></div><div class="actions"><button class="btn btn-sm ' + (item.active ? 'btn-success' : 'btn-outline') + '" data-action="toggle">' + (item.active ? '‚úì' : '‚óã') + '</button><button class="btn btn-sm btn-danger" data-action="delete">‚úï</button></div></div>';
            }
            container.innerHTML = html;
            var itemEls = container.querySelectorAll('.weight-item');
            for (var j = 0; j < itemEls.length; j++) {
                (function(el) {
                    var id = el.getAttribute('data-id'); var buttons = el.querySelectorAll('button');
                    for (var k = 0; k < buttons.length; k++) { (function(btn) { btn.onclick = function(e) { e.stopPropagation(); var action = btn.getAttribute('data-action'); if (action === 'toggle') toggleWCItem(id); if (action === 'delete') deleteWCItem(id); }; })(buttons[k]); }
                })(itemEls[j]);
            }
            updateWCRotationStatus();
        }
        
        function toggleWCItem(id) { var folder = getCurrentFolder(); if (!folder) return; for (var i = 0; i < folder.items.length; i++) { if (folder.items[i].id === id) { folder.items[i].active = !folder.items[i].active; break; } } saveData(); renderWeightCarouselList(); }
        function deleteWCItem(id) { var folder = getCurrentFolder(); if (!folder) return; folder.items = folder.items.filter(function(x) { return x.id !== id; }); saveData(); renderWeightCarouselList(); }
        function wcSelectAll() { var folder = getCurrentFolder(); if (!folder) return; folder.items.forEach(function(i){ i.active = true; }); saveData(); renderWeightCarouselList(); }
        function wcDeselectAll() { var folder = getCurrentFolder(); if (!folder) return; folder.items.forEach(function(i){ i.active = false; }); saveData(); renderWeightCarouselList(); }
        function wcClearSelected() { var folder = getCurrentFolder(); if (!folder) return; if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ?')) { folder.items = folder.items.filter(function(x) { return !x.active; }); saveData(); renderWeightCarouselList(); } }
        
        function deleteCurrentFolder() {
            var folder = getCurrentFolder(); if (!folder) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É');
            if (confirm('–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É "' + folder.name + '"?')) { state.wcFolders = state.wcFolders.filter(function(f) { return f.id !== state.wcSelectedFolderId; }); state.wcSelectedFolderId = null; saveData(); renderFolderList(); renderWeightCarouselList(); updateCurrentFolderName(); stopWCRotation(); }
        }
        function renameCurrentFolder() { var folder = getCurrentFolder(); if (!folder) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É'); var newName = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:', folder.name); if (newName && newName.trim()) { folder.name = newName.trim(); saveData(); renderFolderList(); updateCurrentFolderName(); } }
        function runCurrentFolder() { if (getCurrentFolder()) startWCRotation(); else alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É'); }
        
        function updateWCRotationStatus() {
            var el = document.getElementById('wc-rotation-status'); var folder = getCurrentFolder(); var activeItems = folder ? folder.items.filter(function(x) { return x.active; }) : [];
            if (el) { if (state.wcIsRotating) el.textContent = 'üîÑ –†–æ—Ç–∞—Ü–∏—è: ' + state.wcRotationItems.length + ' —à—Ç'; else if (folder) el.textContent = '‚úì –ê–∫—Ç–∏–≤–Ω–æ: ' + activeItems.length + ' —à—Ç'; else el.textContent = '–°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É'; }
            var controls = document.getElementById('wc-rotation-controls'); if (controls) controls.className = 'rotation-controls' + (state.wcIsRotating ? ' active' : '');
        }
        
        function startWCRotation() {
            var folder = getCurrentFolder(); if (!folder) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É!'); var activeItems = folder.items.filter(function(x) { return x.active; });
            if (activeItems.length === 0) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à—Ç—Ä–∏—Ö–∫–æ–¥!');
            state.wcRotationItems = activeItems; state.wcIsRotating = true; state.wcRotationIndex = 0;
            document.getElementById('wc-start-btn').style.display = 'none'; document.getElementById('wc-stop-btn').style.display = 'inline-flex'; document.getElementById('wcCarouselDisplay').style.display = 'block';
            updateWCRotationStatus(); displayWCBarcode(); startWCTimer();
        }
        
        function stopWCRotation() {
            state.wcIsRotating = false; state.wcRotationItems = []; stopWCTimer();
            document.getElementById('wc-start-btn').style.display = 'inline-flex'; document.getElementById('wc-stop-btn').style.display = 'none'; document.getElementById('wcCarouselDisplay').style.display = 'none';
            updateWCRotationStatus();
        }
        
        function displayWCBarcode() {
            if (state.wcRotationItems.length === 0) return;
            var item = state.wcRotationItems[state.wcRotationIndex % state.wcRotationItems.length];
            var weightDisplay = (item.weight / 1000).toFixed(3) + ' –∫–≥';
            var discountDisplay = (item.prefix === '49' && item.discount !== undefined) ? ' | <strong>–°–∫–∏–¥–∫–∞:</strong> ' + item.discount + '%' : '';

            var infoEl = document.getElementById('wcBarcodeInfo'); var textEl = document.getElementById('wcBarcodeText'); var counterEl = document.getElementById('wcCarouselCounter'); var svg = document.getElementById('wcBarcodeSvg'); var container = document.getElementById('wcCarouselDisplay');
            if (container) { container.classList.remove('scan-effect'); void container.offsetWidth; container.classList.add('scan-effect'); }
            
            if (infoEl) infoEl.innerHTML = '<strong>PLU:</strong> ' + item.plu + ' | <strong>–í–µ—Å:</strong> ' + weightDisplay + discountDisplay;
            if (textEl) textEl.textContent = item.code;
            if (counterEl) { var current = (state.wcRotationIndex % state.wcRotationItems.length) + 1; counterEl.textContent = current + ' / ' + state.wcRotationItems.length; }
            if (svg) { svg.innerHTML = ''; try { if (typeof JsBarcode !== 'undefined') { JsBarcode(svg, item.code, { format: item.format, height: 70, displayValue: true, fontSize: 14, margin: 10 }); } } catch (e) { if (typeof JsBarcode !== 'undefined') { JsBarcode(svg, item.code, { format: 'CODE128', height: 70, displayValue: true, fontSize: 14, margin: 10 }); } } }
            state.wcRotationIndex++;
        }
        
        function startWCTimer() { stopWCTimer(); state.wcRemaining = state.wcTimerValue; state.wcTimerInterval = setInterval(function() { state.wcRemaining -= 0.1; if (state.wcRemaining <= 0.05) { displayWCBarcode(); state.wcRemaining = state.wcTimerValue; } }, 100); }
        function stopWCTimer() { if (state.wcTimerInterval) { clearInterval(state.wcTimerInterval); state.wcTimerInterval = null; } }
        
        function switchToTab(name) {
            var tabs = document.querySelectorAll('.tab-btn'); var contents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active'); for (var j = 0; j < contents.length; j++) contents[j].classList.remove('active');
            document.querySelector('.tab-btn[data-tab="' + name + '"]').classList.add('active'); document.getElementById('tab-' + name).classList.add('active');
        }
        
        function setCustomInterval(value, isWc) {
            var val = parseFloat(value); if (isNaN(val) || val <= 0) return;
            var selector = isWc ? '.wc-interval-btn' : '.interval-btn'; var btns = document.querySelectorAll(selector); for(var i=0; i<btns.length; i++) btns[i].classList.remove('active');
            if (isWc) { state.wcTimerValue = val; state.wcRemaining = val; if (state.wcIsRotating) startWCTimer(); } else { state.timerValue = val; state.remaining = val; startTimer(); }
        }
        
        function init() {
            loadData();
            var tabBtns = document.querySelectorAll('.tab-btn[data-tab]');
            for (var i = 0; i < tabBtns.length; i++) {
                tabBtns[i].onclick = function() {
                    var tab = this.getAttribute('data-tab'); switchToTab(tab);
                    if (tab === 'datamatrix') { generateAndDisplay(); startTimer(); } else { stopTimer(); }
                    if (tab === 'library') renderSavedList();
                    if (tab === 'barcode') renderBarcodeFields();
                    if (tab === 'weightcarousel') { renderFolderList(); renderWeightCarouselList(); updateCurrentFolderName(); }
                    if (tab === 'simplegen') { renderSGFolders(); closeSGFolder(); } 
                    if (tab !== 'weightcarousel' && state.wcIsRotating) stopWCRotation();
                };
            }
            var setupIntervals = function(btnClass, inputId, isWc) {
                var btns = document.querySelectorAll('.' + btnClass); var input = document.getElementById(inputId);
                for (var k = 0; k < btns.length; k++) { btns[k].onclick = function() { var val = this.getAttribute('data-interval'); input.value = val; setCustomInterval(val, isWc); this.classList.add('active'); }; }
                input.onchange = function() { setCustomInterval(this.value, isWc); }; input.onkeyup = function() { setCustomInterval(this.value, isWc); };
            };
            setupIntervals('interval-btn', 'dm-custom-interval', false); setupIntervals('wc-interval-btn', 'wc-custom-interval', true);
            var tmplBtns = document.querySelectorAll('.tmpl-btn'); for (var t = 0; t < tmplBtns.length; t++) { tmplBtns[t].onclick = function() { for (var x = 0; x < tmplBtns.length; x++) tmplBtns[x].classList.remove('active'); this.classList.add('active'); state.selectedTemplate = this.getAttribute('data-template'); }; }
            document.getElementById('refresh-btn').onclick = function() { generateAndDisplay(); startTimer(); };
            document.getElementById('add-btn').onclick = function() { var val = document.getElementById('barcode-input').value; if (val.trim()) { var n = addBarcodes(val); if (n > 0) { document.getElementById('barcode-input').value = ''; alert('–î–æ–±–∞–≤–ª–µ–Ω–æ: ' + n); } else alert('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –∫–æ–¥–æ–≤'); } };
            document.getElementById('clear-input-btn').onclick = function() { document.getElementById('barcode-input').value = ''; };
            document.getElementById('select-all-btn').onclick = selectAll; document.getElementById('deselect-all-btn').onclick = deselectAll; document.getElementById('start-btn').onclick = startRotation; document.getElementById('stop-btn').onclick = stopRotation; document.getElementById('clear-all-btn').onclick = clearAll;
            document.getElementById('barcodeType').onchange = renderBarcodeFields; document.getElementById('generateBarcodeBtn').onclick = handleGenerateBarcode;
            document.getElementById('wcAddToCarousel').onclick = addToWeightCarousel; document.getElementById('wc-select-all').onclick = wcSelectAll; document.getElementById('wc-deselect-all').onclick = wcDeselectAll; document.getElementById('wc-clear-selected').onclick = wcClearSelected; document.getElementById('wc-start-btn').onclick = startWCRotation; document.getElementById('wc-stop-btn').onclick = stopWCRotation; document.getElementById('wc-run-folder').onclick = runCurrentFolder; document.getElementById('wc-rename-folder').onclick = renameCurrentFolder; document.getElementById('wc-delete-folder').onclick = deleteCurrentFolder;
            
            document.getElementById('wcPrefix49').onchange = toggleDiscountVisibility;
            
            document.getElementById('sgValue').addEventListener('input', handleSimpleGenerator);
            document.getElementById('sgAddBtn').onclick = saveToSGFolder;
            document.getElementById('sgBackBtn').onclick = closeSGFolder;
            document.getElementById('sgNextBtn').onclick = sgNext;
            document.getElementById('sgPrevBtn').onclick = sgPrev;
            document.getElementById('sgRenameFolderBtn').onclick = sgRenameFolder;
            document.getElementById('sgDeleteFolderBtn').onclick = sgDeleteFolder;
            document.getElementById('sgDeleteItemBtn').onclick = sgDeleteItem;
            document.getElementById('sgFolderModeBtn').onclick = function() { toggleSGFolderMode(); };
            
            document.getElementById('exportDataBtn').onclick = exportData;
            document.getElementById('importFile').onchange = importData;
            
            // New DM Controls Listeners
            document.getElementById('dm-pause-btn').onclick = stopTimer;
            document.getElementById('dm-play-btn').onclick = startTimer;
            document.getElementById('dm-next-btn').onclick = dmManualNext;
            document.getElementById('dm-prev-btn').onclick = dmManualPrev;

            // KEYBOARD EVENT LISTENER
            document.addEventListener('keydown', function(e) {
                var dmTab = document.getElementById('tab-datamatrix');
                // Only if DM tab is active and Timer is STOPPED (state.timerInterval is null)
                if (dmTab && dmTab.classList.contains('active') && !state.timerInterval) {
                    if (e.key === 'ArrowLeft') dmManualPrev();
                    if (e.key === 'ArrowRight') dmManualNext();
                }
            });

            document.addEventListener('visibilitychange', function() { if (document.hidden) { stopTimer(); stopWCTimer(); } else { var dmTab = document.getElementById('tab-datamatrix'); if (dmTab && dmTab.classList.contains('active')) { generateAndDisplay(); startTimer(); } if (state.wcIsRotating) { displayWCBarcode(); startWCTimer(); } } });
            renderSavedList(); renderBarcodeFields(); renderFolderList(); renderWeightCarouselList(); updateCurrentFolderName(); toggleWeightMode(); toggleDiscountVisibility(); renderSGFolders();
            setTimeout(function() { generateAndDisplay(); startTimer(); }, 300);
        }
        if (document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(init, 50); else document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
